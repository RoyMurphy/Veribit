"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.BAP_ID=void 0;var _HDPrivateKey,_BAP_SERVER,_BAP_TOKEN,_rootPath,_previousPath,_currentPath,_idSeed,_temp,_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_classPrivateFieldLooseBase2=_interopRequireDefault(require("@babel/runtime/helpers/classPrivateFieldLooseBase")),_classPrivateFieldLooseKey2=_interopRequireDefault(require("@babel/runtime/helpers/classPrivateFieldLooseKey")),_bsv=_interopRequireDefault(require("bsv")),_ecies=_interopRequireDefault(require("bsv/ecies")),_message=_interopRequireDefault(require("bsv/message")),_constants=require("./constants"),_utils=require("./utils");function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var BAP_ID=(_temp=(_HDPrivateKey=(0,_classPrivateFieldLooseKey2["default"])("HDPrivateKey"),_BAP_SERVER=(0,_classPrivateFieldLooseKey2["default"])("BAP_SERVER"),_BAP_TOKEN=(0,_classPrivateFieldLooseKey2["default"])("BAP_TOKEN"),_rootPath=(0,_classPrivateFieldLooseKey2["default"])("rootPath"),_previousPath=(0,_classPrivateFieldLooseKey2["default"])("previousPath"),_currentPath=(0,_classPrivateFieldLooseKey2["default"])("currentPath"),_idSeed=(0,_classPrivateFieldLooseKey2["default"])("idSeed"),function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"";if((0,_classCallCheck2["default"])(this,a),Object.defineProperty(this,_HDPrivateKey,{writable:!0,value:null}),Object.defineProperty(this,_BAP_SERVER,{writable:!0,value:_constants.BAP_SERVER}),Object.defineProperty(this,_BAP_TOKEN,{writable:!0,value:""}),Object.defineProperty(this,_rootPath,{writable:!0,value:void 0}),Object.defineProperty(this,_previousPath,{writable:!0,value:void 0}),Object.defineProperty(this,_currentPath,{writable:!0,value:void 0}),Object.defineProperty(this,_idSeed,{writable:!0,value:void 0}),(0,_classPrivateFieldLooseBase2["default"])(this,_idSeed)[_idSeed]=d,d){var e=_bsv["default"].crypto.Hash.sha256(Buffer.from(d)).toString("hex"),f=_utils.Utils.getSigningPathFromHex(e);(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey]=b.deriveChild(f)}else(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey]=b;this.name="ID 1",this.description="",(0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]="".concat(_constants.SIGNING_PATH_PREFIX,"/0/0/0"),(0,_classPrivateFieldLooseBase2["default"])(this,_previousPath)[_previousPath]="".concat(_constants.SIGNING_PATH_PREFIX,"/0/0/0"),(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath]="".concat(_constants.SIGNING_PATH_PREFIX,"/0/0/1");var g=(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey].deriveChild((0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]);this.rootAddress=g.privateKey.publicKey.toAddress().toString(),this.identityKey=this.deriveIdentityKey(this.rootAddress),c=_objectSpread({},c),this.identityAttributes=this.parseAttributes(c)}return(0,_createClass2["default"])(a,[{key:"BAP_SERVER",get:function get(){return(0,_classPrivateFieldLooseBase2["default"])(this,_BAP_SERVER)[_BAP_SERVER]},set:function set(a){(0,_classPrivateFieldLooseBase2["default"])(this,_BAP_SERVER)[_BAP_SERVER]=a}},{key:"BAP_TOKEN",get:function get(){return(0,_classPrivateFieldLooseBase2["default"])(this,_BAP_TOKEN)[_BAP_TOKEN]},set:function set(a){(0,_classPrivateFieldLooseBase2["default"])(this,_BAP_TOKEN)[_BAP_TOKEN]=a}},{key:"deriveIdentityKey",value:function deriveIdentityKey(a){var b=_bsv["default"].crypto.Hash.sha256(Buffer.from(a));return _bsv["default"].encoding.Base58(_bsv["default"].crypto.Hash.ripemd160(b)).toString()}},{key:"parseAttributes",value:function parseAttributes(a){return"string"==typeof a?this.parseStringUrns(a):(Object.keys(a).forEach(function(b){if(!a[b].hasOwnProperty("value")||!a[b].hasOwnProperty("nonce"))throw new Error("Invalid identity attribute")}),a||{})}},{key:"parseStringUrns",value:function parseStringUrns(a){var b={};return a.replace(/^\s+/g,"").replace(/\r/gm,"").split("\n").forEach(function(a){a=a.replace(/^\s+/g,"").replace(/\s+$/g,"");var c=a.split(":");"urn"===c[0]&&"bap"===c[1]&&"id"===c[2]&&c[3]&&c[4]&&c[5]&&(b[c[3]]={value:c[4],nonce:c[5]})}),b}},{key:"getIdentityKey",value:function getIdentityKey(){return this.identityKey}},{key:"getAttributes",value:function getAttributes(){return this.identityAttributes}},{key:"getAttribute",value:function getAttribute(a){return this.identityAttributes.hasOwnProperty(a)?this.identityAttributes[a]:null}},{key:"setAttribute",value:function setAttribute(a,b){b&&(this.identityAttributes.hasOwnProperty(a)?this.identityAttributes[a].value=b:this.addAttribute(a,b))}},{key:"unsetAttribute",value:function unsetAttribute(a){delete this.identityAttributes[a]}},{key:"getAttributeUrns",value:function getAttributeUrns(){var a=this,b="";return Object.keys(this.identityAttributes).forEach(function(c){var d=a.getAttributeUrn(c);d&&(b+="".concat(d,"\n"))}),b}},{key:"getAttributeUrn",value:function getAttributeUrn(a){var b=this.identityAttributes[a];return b?"urn:bap:id:".concat(a,":").concat(b.value,":").concat(b.nonce):null}},{key:"addAttribute",value:function addAttribute(a,b){var c=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2];c||(c=_utils.Utils.getRandomString()),this.identityAttributes[a]={value:b,nonce:c}}},{key:"rootPath",get:function get(){return(0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]},set:function set(a){if(5>a.split("/").length&&(a="".concat(_constants.SIGNING_PATH_PREFIX).concat(a)),!this.validatePath(a))throw new Error("invalid signing path given "+a);(0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]=a;var b=(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey].deriveChild(a);this.rootAddress=b.publicKey.toAddress().toString(),this.identityKey=this.deriveIdentityKey(this.rootAddress),(0,_classPrivateFieldLooseBase2["default"])(this,_previousPath)[_previousPath]=a,(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath]=a}},{key:"currentPath",get:function get(){return(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath]},set:function set(a){if(5>a.split("/").length&&(a="".concat(_constants.SIGNING_PATH_PREFIX).concat(a)),!this.validatePath(a))throw new Error("invalid signing path given");(0,_classPrivateFieldLooseBase2["default"])(this,_previousPath)[_previousPath]=(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath],(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath]=a}},{key:"previousPath",get:function get(){return(0,_classPrivateFieldLooseBase2["default"])(this,_previousPath)[_previousPath]}},{key:"idSeed",get:function get(){return(0,_classPrivateFieldLooseBase2["default"])(this,_idSeed)[_idSeed]}},{key:"incrementPath",value:function incrementPath(){this.currentPath=_utils.Utils.getNextPath(this.currentPath)}},{key:"validatePath",value:function validatePath(a){if(a.match(/\/[0-9]{1,10}'?\/[0-9]{1,10}'?\/[0-9]{1,10}'?\/[0-9]{1,10}'?\/[0-9]{1,10}'?\/[0-9]{1,10}'?/)){var b=a.split("/");if(7===b.length&&+b[1].replace("'","")<=_constants.MAX_INT&&+b[2].replace("'","")<=_constants.MAX_INT&&+b[3].replace("'","")<=_constants.MAX_INT&&+b[4].replace("'","")<=_constants.MAX_INT&&+b[5].replace("'","")<=_constants.MAX_INT&&+b[6].replace("'","")<=_constants.MAX_INT)return!0}return!1}},{key:"getInitialIdTransaction",value:function getInitialIdTransaction(){return this.getIdTransaction((0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath])}},{key:"getIdTransaction",value:function getIdTransaction(){var a=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0];if((0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath]===(0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath])throw new Error("Current path equals rootPath. ID was probably not initialized properly");var b=[Buffer.from(_constants.BAP_BITCOM_ADDRESS).toString("hex"),Buffer.from("ID").toString("hex"),Buffer.from(this.identityKey).toString("hex"),Buffer.from(this.getCurrentAddress()).toString("hex")];return a=a||(0,_classPrivateFieldLooseBase2["default"])(this,_previousPath)[_previousPath],this.signOpReturnWithAIP(b,a)}},{key:"getAddress",value:function getAddress(a){var b=(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey].deriveChild(a);return b.privateKey.publicKey.toAddress().toString()}},{key:"getCurrentAddress",value:function getCurrentAddress(){return this.getAddress((0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath])}},{key:"getEncryptionPublicKey",value:function getEncryptionPublicKey(){var a=(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey].deriveChild((0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]),b=a.deriveChild(_constants.ENCRYPTION_PATH).privateKey;return b.publicKey.toString("hex")}},{key:"encrypt",value:function encrypt(a){var b=_bsv["default"].PublicKey.fromHex(this.getEncryptionPublicKey()),c=new _ecies["default"];return c.publicKey(b),c.encrypt(a).toString("base64")}},{key:"decrypt",value:function decrypt(a){var b=(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey].deriveChild((0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]),c=b.deriveChild(_constants.ENCRYPTION_PATH).privateKey,d=new _ecies["default"];return d.privateKey(c),d.decrypt(Buffer.from(a,"base64")).toString()}},{key:"getAttestation",value:function getAttestation(a){var b=_bsv["default"].crypto.Hash.sha256(Buffer.from(a));return"bap:attest:".concat(b.toString("hex"),":").concat(this.getIdentityKey())}},{key:"getAttestationHash",value:function getAttestationHash(a){var b=this.getAttributeUrn(a);if(!b)return null;var c=this.getAttestation(b),d=_bsv["default"].crypto.Hash.sha256(Buffer.from(c));return d.toString("hex")}},{key:"signMessage",value:function signMessage(a){var b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];a instanceof Buffer||(a=Buffer.from(a)),b=b||(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath];var c=(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey].deriveChild(b),d=c.privateKey.publicKey.toAddress().toString(),e=(0,_message["default"])(a).sign(c.privateKey);return{address:d,signature:e}}},{key:"signMessageWithSeed",value:function signMessageWithSeed(a,b){var c=_bsv["default"].crypto.Hash.sha256(Buffer.from(b)).toString("hex"),d=_utils.Utils.getSigningPathFromHex(c),e=(0,_classPrivateFieldLooseBase2["default"])(this,_HDPrivateKey)[_HDPrivateKey].deriveChild((0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]),f=e.deriveChild(d),g=f.privateKey.publicKey.toAddress().toString(),h=(0,_message["default"])(a).sign(f.privateKey);return{address:g,signature:h}}},{key:"signOpReturnWithAIP",value:function signOpReturnWithAIP(a){var b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"hex",d=this.getAIPMessageBuffer(a),e=this.signMessage(d,b),f=e.address,g=e.signature;return a.concat([Buffer.from("|").toString(c),Buffer.from(_constants.AIP_BITCOM_ADDRESS).toString(c),Buffer.from("BITCOIN_ECDSA").toString(c),Buffer.from(f).toString(c),Buffer.from(g,"base64").toString(c)])}},{key:"getAIPMessageBuffer",value:function getAIPMessageBuffer(a){var b=[];return"6a"!==a[0].replace("0x","")&&b.push(Buffer.from("6a","hex")),a.forEach(function(a){b.push(Buffer.from(a.replace("0x",""),"hex"))}),b.push(Buffer.from("|")),Buffer.concat([].concat(b))}},{key:"getIdSigningKeys",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.getApiData("/signing-keys",{idKey:this.identityKey});case 2:return b=a.sent,console.log("getIdSigningKeys",b),a.abrupt("return",b);case 5:case"end":return a.stop();}},a,this)}));return function getIdSigningKeys(){return a.apply(this,arguments)}}()},{key:"getAttributeAttestations",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=this.getAttestationHash(b),a.next=3,this.getApiData("/attestations",{hash:c});case 3:return d=a.sent,console.log("getAttestations",b,c,d),a.abrupt("return",d);case 6:case"end":return a.stop();}},a,this)}));return function getAttributeAttestations(){return a.apply(this,arguments)}}()},{key:"getApiData",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d="".concat((0,_classPrivateFieldLooseBase2["default"])(this,_BAP_SERVER)[_BAP_SERVER]).concat(b),a.next=3,fetch(d,{method:"post",headers:{"Content-type":"application/json; charset=utf-8",token:(0,_classPrivateFieldLooseBase2["default"])(this,_BAP_TOKEN)[_BAP_TOKEN],format:"json"},body:JSON.stringify(c)});case 3:return e=a.sent,a.abrupt("return",e.json());case 5:case"end":return a.stop();}},a,this)}));return function getApiData(){return a.apply(this,arguments)}}()},{key:"import",value:function _import(a){this.name=a.name,this.description=a.description||"",this.identityKey=a.identityKey,(0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath]=a.rootPath,this.rootAddress=a.rootAddress,(0,_classPrivateFieldLooseBase2["default"])(this,_previousPath)[_previousPath]=a.previousPath,(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath]=a.currentPath,(0,_classPrivateFieldLooseBase2["default"])(this,_idSeed)[_idSeed]=a.idSeed||"",this.identityAttributes=this.parseAttributes(a.identityAttributes)}},{key:"export",value:function _export(){return{name:this.name,description:this.description,identityKey:this.identityKey,rootPath:(0,_classPrivateFieldLooseBase2["default"])(this,_rootPath)[_rootPath],rootAddress:this.rootAddress,previousPath:(0,_classPrivateFieldLooseBase2["default"])(this,_previousPath)[_previousPath],currentPath:(0,_classPrivateFieldLooseBase2["default"])(this,_currentPath)[_currentPath],idSeed:(0,_classPrivateFieldLooseBase2["default"])(this,_idSeed)[_idSeed],identityAttributes:this.getAttributes()}}}]),a}()),_temp);exports.BAP_ID=BAP_ID;